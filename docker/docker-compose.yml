# Lumina Photo Analysis Pipeline - Production
#
# This compose file pulls published images from Docker Hub.

services:
  # CPU variant - pulls from Docker Hub
  lumina-cpu:
    image: stevenvanassche/lumina:cpu-1.1.0
    container_name: lumina-cpu
    environment:
      # Mode selection
      - LUMINA_MODE=cpu

      # Performance tuning
      - LUMINA_WORKERS=${LUMINA_WORKERS:-2}
      - LUMINA_BATCH_SIZE=${LUMINA_BATCH_SIZE:-5}
      - LUMINA_PARALLEL_BATCHES=${LUMINA_PARALLEL_BATCHES:-2}
      - LUMINA_RAY_CPUS=${LUMINA_RAY_CPUS:-auto}
      - LUMINA_TORCH_THREADS=${LUMINA_TORCH_THREADS:-4}

      # Configuration
      - LUMINA_LOG_LEVEL=${LUMINA_LOG_LEVEL:-INFO}
      - LUMINA_ENABLE_CHECKPOINTS=${LUMINA_ENABLE_CHECKPOINTS:-true}
      - LUMINA_EXECUTION_MODE=${LUMINA_EXECUTION_MODE:-normal_scan}

      # Watch mode (v1.1)
      - LUMINA_WATCH_MODE=${LUMINA_WATCH_MODE:-off}
      - LUMINA_MODEL_IDLE_TIMEOUT=${LUMINA_MODEL_IDLE_TIMEOUT:-auto}
      - LUMINA_WATCH_IDLE_EXIT=${LUMINA_WATCH_IDLE_EXIT:-0}

      # RAW file support (v1.1) - enabled by default, groups RAW+JPEG pairs
      - LUMINA_RAW_SUPPORT=${LUMINA_RAW_SUPPORT:-on}

      # Ray configuration
      - RAY_ACCEL_ENV_VAR_OVERRIDE_ON_ZERO=0

    volumes:
      # Required: Photos to process (read-write for XMP and JSON sidecar mode)
      - ${PHOTOS_PATH:-./photos}:/data/photos

      # Required: Cache for models, checkpoints, logs, and image_cache
      - ${CACHE_PATH:-./cache}:/data/cache

    restart: no

    # Shared memory size for Ray object store
    shm_size: '2gb'

    # Resource limits (optional)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '8'
    #       memory: 16G

    profiles:
      - cpu

  # GPU variant - pulls from Docker Hub
  lumina-gpu:
    image: stevenvanassche/lumina:gpu-1.1.0
    container_name: lumina-gpu
    environment:
      # Mode selection
      - LUMINA_MODE=gpu

      # Performance tuning (can handle larger batches with GPU)
      - LUMINA_WORKERS=${LUMINA_WORKERS:-1}
      - LUMINA_BATCH_SIZE=${LUMINA_BATCH_SIZE:-10}
      - LUMINA_PARALLEL_BATCHES=${LUMINA_PARALLEL_BATCHES:-3}
      - LUMINA_RAY_CPUS=${LUMINA_RAY_CPUS:-auto}
      - LUMINA_TORCH_THREADS=${LUMINA_TORCH_THREADS:-4}

      # Configuration
      - LUMINA_LOG_LEVEL=${LUMINA_LOG_LEVEL:-INFO}
      - LUMINA_ENABLE_CHECKPOINTS=${LUMINA_ENABLE_CHECKPOINTS:-true}
      - LUMINA_EXECUTION_MODE=${LUMINA_EXECUTION_MODE:-normal_scan}

      # Watch mode (v1.1)
      - LUMINA_WATCH_MODE=${LUMINA_WATCH_MODE:-off}
      - LUMINA_MODEL_IDLE_TIMEOUT=${LUMINA_MODEL_IDLE_TIMEOUT:-auto}
      - LUMINA_WATCH_IDLE_EXIT=${LUMINA_WATCH_IDLE_EXIT:-0}

      # RAW file support (v1.1) - enabled by default, groups RAW+JPEG pairs
      - LUMINA_RAW_SUPPORT=${LUMINA_RAW_SUPPORT:-on}

      # Ray configuration
      - RAY_ACCEL_ENV_VAR_OVERRIDE_ON_ZERO=0

    volumes:
      # Required: Photos to process (read-write for XMP and JSON sidecar mode)
      - ${PHOTOS_PATH:-./photos}:/data/photos

      # Required: Cache for models, checkpoints, logs, and image_cache
      - ${CACHE_PATH:-./cache}:/data/cache

    restart: no

    # Shared memory size for Ray object store
    shm_size: '2gb'

    # GPU configuration
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all  # or specific count: 1
              capabilities: [gpu]

    profiles:
      - gpu

# Usage examples:
#
# CPU variant (pulls stevenvanassche/lumina:cpu-1.1.0):
#   docker compose --profile cpu up
#   docker compose --profile cpu up -d  (detached)
#
# GPU variant (pulls stevenvanassche/lumina:gpu-1.1.0):
#   docker compose --profile gpu up
#   docker compose --profile gpu up -d
#
# Watch mode (continuous monitoring for new photos):
#   LUMINA_WATCH_MODE=on docker compose --profile cpu up
#
# Disable RAW+JPEG pairing (process JPEG files only):
#   LUMINA_RAW_SUPPORT=off docker compose --profile cpu up
#
# Pull latest version before running:
#   docker compose pull
#   docker compose --profile cpu up
#
# Stop:
#   docker compose --profile cpu down
#   docker compose --profile gpu down
#
# View logs:
#   docker compose --profile cpu logs -f
#   docker compose --profile gpu logs -f
#
# Environment variables (optional):
#   PHOTOS_PATH=/path/to/photos CACHE_PATH=/path/to/cache \
#   docker compose --profile cpu up
